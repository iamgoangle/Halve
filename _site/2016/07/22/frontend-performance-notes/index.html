<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Frontend Engineer - Thinking about performance &#8211; Teerapong Singthong</title> <meta name="description" content=""> <meta name="keywords" content="performance, browser, javascript"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="golf-logo.png"> <meta name="twitter:title" content="Frontend Engineer - Thinking about performance"> <meta name="twitter:description" content=""> <meta name="twitter:site" content="@iamgoangle"> <meta name="twitter:creator" content="@iamgoangle"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Frontend Engineer - Thinking about performance"> <meta property="og:description" content=""> <meta property="og:url" content="https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/"> <meta property="og:site_name" content="Teerapong Singthong"> <meta property="og:image" content="https://iamgoangle.github.io/images/golf-logo.png"> <link rel="canonical" href="https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="https://iamgoangle.github.io/feed.xml" title="Teerapong Singthong" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="https://iamgoangle.github.io/favicon.png" /> <link rel="shortcut icon" href="https://iamgoangle.github.io/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="https://iamgoangle.github.io/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://iamgoangle.github.io/images/post-wall.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://iamgoangle.github.io/images/12043050_982005851847216_7927084816037540014_n.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(https://iamgoangle.github.io/images/golf-home.png) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="https://iamgoangle.github.io" class="logo"><img src="https://iamgoangle.github.io/images/golf-logo.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Frontend Engineer - Thinking about performance </h1> <ul class="tags"> <li><a href="https://iamgoangle.github.io/tags#performance">performance</a></li> <li><a href="https://iamgoangle.github.io/tags#browser">browser</a></li> <li><a href="https://iamgoangle.github.io/tags#javascript">javascript</a></li> </ul> <div class="section-line reverse"><a href="https://iamgoangle.github.io/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">22 Jul 2016</div> <h2 id="performance-">เราให้ความสำคัญกับ Performance มากแค่ไหน?</h2> <p>ทุกวันนี้อัตราความเร็วเครื่องคอมพิวเตอร์ หรือ มือถือ รวมไปถึง Smart devices ต่างๆที่สามารถเชื่อมต่ออินเตอร์เนตได้ กำลังแข่งขันกันในเรื่องความเร็วในการประมวลผล แน่นอนว่าความเร็วที่แข่งขันกันอยู่นั้น มันก็เป็นผลดีต่อผู้บริโภค ที่สามารถมีตัวเลือกมากมาย</p> <p>ผู้บริโภคโดยส่วนใหญ่ใช้อุปกรณ์เหล่านี้ในการเข้าเวปไซต์ ใช่ไหมครับ? คำตอบ คือ ใช่ และเป็นที่แน่นอนว่า การใช้ทรัพยากรของเครื่อง เพื่อเปิดสักเวปไซต์นึงนี่ มันกินทรัพยากรไม่มากหรอก</p> <p>มันก็จริง! แต่นั่นมันอาจทำให้เราไม่ได้ใส่ใจกับเรื่อง Performance เพราะ เราคิดไปเองว่าคอมพิวเตอร์เดียวนี้มันแรง</p> <p>แต่อย่าลืมว่า แม้ว่าเครื่องของผู้ใช้จะแรงเพียงใด แต่การออกแบบ Frontend ที่ไม่ได้ใส่ใจกับเรื่อง Performance มันก็ตอบสนองผู้ใช้ช้าอยู่ดี และรวมไปถึง User Experience ที่แย่อีกด้วย</p> <h2 id="frontend-optimization-">ถ้าเราจะเริ่มต้น Frontend Optimization เราควรมองปัจจัยอะไรบ้าง?</h2> <p>มีคำที่กล่าวว่า “Personal experience all tell us the fast is best” ดังนั้น เราลองมาพิจารณาเรื่องเล็กน้อยที่เราควรปรับปรุงเวปไซต์ของเราให้ดีขึ้น เช่น ่</p> <ol> <li> <p>ความเร็วในการแสดงผล</p> </li> <li> <p>ความเร็วในการตอบสนอง</p> </li> <li> <p>การทำงานเบื้องหน้า เบื้องหลังต้องดีเยี่ยม</p> </li> <li> <p>ลด HTTP Request ที่ไม่จำเป็น</p> </li> <li> <p>เข้าใจธรรมชาติของ Web Browser</p> </li> </ol> <h2 id="browser-">เข้าใจธรรมชาติของ Browser กันแบบคร่าวๆกันก่อน</h2> <p>ก่อนที่ Web Browser สักหนึ่งตัวจะแสดงผล HTML ที่เราเขียน ออกมาบนหน้าจอ Browser มีสิ่งที่เรียกว่า Browser Rendering Engine หรือ มันคือเครื่องมือที่ Browser ใช้ตีความ และทำความเข้าใจ HTML ที่เขียนไว้</p> <div class="highlighter-rouge"><pre class="highlight"><code>Different browsers use different rendering engines: Internet Explorer uses Trident, Firefox uses Gecko, Safari uses WebKit. Chrome and Opera (from version 15) use Blink, a fork of WebKit.

WebKit is an open source rendering engine which started as an engine for the Linux platform and was modified by Apple to support Mac and Windows. See webkit.org for more details.
</code></pre></div> <p>Ref: <a href="http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/">http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/</a></p> <p>คราวนี้มาดูขั้นตอนการทำงานคร่าวๆกัน</p> <ol> <li> <p>Rendering engine ทำการรับ content html ที่ download มาผ่านทาง Network Layer จากนั้น ทำการแบ่งข้อมูลออกเป็นก้อนๆ ตีความว่า ก้อนละ 8kb มองเป็นเค้กก้อนละ 8kb ก็ได้</p> </li> <li> <p>Parsing HTML และแปลงเป็น DOM เพื่อให้ ออกมาอยู่ในรูปแบบ Tree Structure หรือ โครงสร้างต้นไม้</p> </li> <li> <p>มาถึงจุดสำคัญละครับ !!! ในจุดนี้เองถ้า Rendering Engine พบว่า มี External resource เช่น <code class="highlighter-rouge">&lt;script src=""&gt;</code> หรือ <code class="highlighter-rouge">&lt;link rel=""&gt;</code> หรือสคริปจำพวกการโหลดไฟล์ ตัว Rendering Engine จะหยุด หยุดจริงๆครับ และทำการ Execute ตีความจนเสร็จ</p> </li> <li> <p>เมื่อเสร็จสิ้นกระบวนการเกี่ยวกับ Javascript, Stylesheet ตัว Rendering engine จะทำการสร้าง Render Tree</p> </li> <li> <p>จากนั้นก็ Parsing html to DOM ไปเรื่อยๆจนเสร็จ</p> </li> <li> <p>ยังไม่จบ!! Rendering Engine จะเข้าสู่กระบวนการต่อ ที่เรียกว่า Layout process เพื่อบอก Browser ว่า element ต่อไปนี้ ควรอยู่จัดใดของหน้าเว็ป</p> </li> <li> <p>และกระบวนการสุดท้าย ก็คือ นำ Render Tree มาผนวกกับ Layout process เพื่อรวม Style และแสดงผลบนหน้าจออย่างสวยงาม</p> </li> </ol> <p>Ref: <a href="http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/">http://www.html5rocks.com/en/tutorials/internals/howbrowserswork/</a> <a href="https://armno.github.io/2016/01/28/how-web-browsers-work">https://armno.github.io/2016/01/28/how-web-browsers-work</a></p> <h2 id="section">และแล้วเราก็เจอปัญหาจนได้</h2> <p>จากการทำงานคร่าวๆของ Browser เราจับใจความได้ว่า มันทำงาน แบบ Synchronously execute นี่หว่า แม่งศัพท์เทคนิคอีกละ !! ก็คือ มันหยุดรอครับ เมื่อเจอ script เกี่ยวกับ JavaScript, CSS แล้วจะเกิดอะไรขึ้นที่หน้าจอของผู้ใช้ นั่นก็คือ หน้าขาวๆ นิ่งๆ ที่รอโหลด</p> <p>สิ่งนี้เรียกว่า <code class="highlighter-rouge">Browser render-blocking-resources</code> แต่ก็อย่างที่บอกครับ โลกของการทำให้ Performance ในส่วนของ Frontend ดีขึ้น ไม่ใช่แค่ แก้เรื่อง Browser render-blocking-resources ครับ</p> <h2 id="solutions">Solutions</h2> <p>สำหรับเนื้อหาตรงนี้ ผมได้รวบรวมศัพท์เทคนิค (เผื่อเอาไป Search google หาข้อมูลเพิ่มเติม) สำหรับการเพิ่มประสิทธิภาพเพื่อช่วยให้ Frontend ทำงานได้ดียิ่งขึ้น โดยแบ่งออกเป็นหัวข้อต่างๆ ดังนี้</p> <h3 id="programming-technique">Programming Technique</h3> <ol> <li> <p>Prevent the browser render blocking resources</p> <p>Browser จะหยุดรอ ให้ JS/CSS พวกนี้ทำงานเสร็จก่อน ถึงจะทำการ Render page ได้ นั่นหมายความว่า จะเกิดเหตุการณ์ หน้าขาวเนื่องจากรอโหลด และทำให้ผู้ใช้ต้องรอ</p> <p>งั้นลองแก้ไขปัญหาแบบง่ายด้วย 2 วิธีนี้ดู - Inline JavaScript/CSS เฉพาะส่วนที่อยากให้แสดงเร็วๆ ทำงานทันที - Asynchronous loading js file แต่ต้องยอมรับว่าการใช้เทคนิคนี้ มันจะทำให้ Page render เลยใช่ไหมครับ แต่จะพบว่า Style มีจุดบกพร่องในการแสดงผล เนื้องจาก Style ถูกโหลดมาทีหลัง</p> <p>ถ้าสนใจลองศึกษา <a href="https://github.com/typekit/webfontloader">https://github.com/typekit/webfontloader</a> สำหรับโหลด web font <a href="https://github.com/filamentgroup/loadCSS">https://github.com/filamentgroup/loadCSS</a> สำหรับโหลด CSS <a href="http://www.w3schools.com/tags/att_script_async.asp">http://www.w3schools.com/tags/att_script_async.asp</a> สำหรับโหลด JS</p> <p>ข้างบนทั้งหมด คือ การโหลดแบบ Asynchronous</p> <p>อ่านเพิ่มเติม:</p> <p><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css?hl=en">https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css?hl=en</a> <a href="https://developers.google.com/speed/docs/insights/BlockingJS">https://developers.google.com/speed/docs/insights/BlockingJS</a> <a href="http://armno.github.io/2015/05/04/use-loadcss-to-improve-rendering-performance">http://armno.github.io/2015/05/04/use-loadcss-to-improve-rendering-performance</a></p> </li> <li> <p>JavaScript Uglify/Minify</p> <p>อีกวิธีการที่จะช่วยให้ Browser HTTP Request ไปยัง assets ไม่ว่าจะเป็น HTML, JS และ CSS เพื่อดาวน์โหลดได้ไวขึ้น นั่น คือ การทำ Uglify หรือ Minify เพื่อทำให้ไฟล์เหล่านี้ มีขนาดที่เล็กลง</p> <p>ผมใช้ gulp ในการ minify js และ css ทุกครั้งเมื่อมีการ save file</p> <p>อ่านเพิ่มเติม:</p> <p><a href="https://developers.google.com/speed/docs/insights/MinifyResources">https://developers.google.com/speed/docs/insights/MinifyResources</a> <a href="http://codehangar.io/concatenate-and-minify-javascript-with-gulp/">http://codehangar.io/concatenate-and-minify-javascript-with-gulp/</a> <a href="https://css-tricks.com/gulp-for-beginners/">https://css-tricks.com/gulp-for-beginners/</a></p> </li> <li> <p>CSS Uglify/Minify</p> </li> <li> <p>Make inline css or javascript</p> </li> <li> <p>RESTFul APIs only return minimal value via header instead body</p> </li> <li> <p>Asynchronous loading the assets</p> </li> </ol> <h3 id="network">Network</h3> <ol> <li> <p>Make Fewer Requests ง่ายที่สุดที่สำหรับวิธีนี้ คือ HTTP request ให้น้อยที่สุดเท่าที่เป็นไปได้</p> </li> <li> <p>Maximising parallelisation / Parallel Downloads Across Domains โดยปกติแล้ว Browser สามารถทำสิ่งที่เรียกว่า Multiple (Parallel) HTTP Request at once หรือ Browser สามารถ HTTP Request พร้อมกันได้มากกว่า 1 request ในช่วงเวลานึง สำหรับ 1 domain name แต่!! ไม่เกิน 3-6 Requests และนี่ คือ ปัญหาคอขวดของ Web Browser</p> <p>อีกความหมาย คือ เมื่อ Browser พยายาม Request ไปยัง สักหนึ่งเวปไซต์ Browser สามารถโหลด Assets ต่างๆ เช่น รูป ไฟล์ พร้อมกันได้ สำหรับ 1 domain ในหนึ่งช่วงเวลา แต่มันก็ยังมีข้อจำกัดที่ 6 request อยู่ดี</p> <p>แต่เราสามารถใช้เทคนิค domain sharding ได้ ด้วยการ HTTP Request ไปยัง sub.domain หรือ across multiple domains</p> <p>หรือการ request ไปยัง sub domain มันจะทำให้ ในหนึ่งช่วงเวลา จากเดิม สมมุติเรา request = 6 เมื่อโค๊ดของเรามีการ request sub domain ด้วย เราก็จะได้อีก 6 ในช่วงเวลาเดียวกัน</p> <p>อ่านเพิ่มเติม:</p> <p><a href="http://csswizardry.com/2013/01/front-end-performance-for-web-designers-and-front-end-developers/#section:http-requests-and-dns-lookups">http://csswizardry.com/2013/01/front-end-performance-for-web-designers-and-front-end-developers/#section:http-requests-and-dns-lookups</a> <a href="https://www.keycdn.com/blog/parallel-downloads-across-domains/">https://www.keycdn.com/blog/parallel-downloads-across-domains/</a></p> </li> <li> <p>ใช้ CDN (Content Delivery Network) แทนการอ้างสคริปภายใต้ domain web server ของเรา หากเราต้องการลดภาระของ web server ของเรา ในการ deliver assets เช่น js, css framework ให้กับ User เราสามารถใช้ CDN ที่เขา host file เหล่านี้ไว้ให้แล้ว</p> <p>และอีกสาเหตุหนึ่งที่เป็นหัวใจหลักของ CDN นั่นก็คือ ระบบ caching, shorted path ในการ deliver assets ที่ผมบอกข้างบน</p> <p>สมมุติว่า Web server ผมอยู่ที่ US แต่มี User ที่ใช้งานเวปไซต์ผมที่ Bangkok แน่นอนว่า ไกลกันมากในระยะทางการให้บริการ ถ้าหากเราใช้ CDN เช่น Google CDN ตัว server ของ google จะทำการหา CDN Node ที่ใกล้เรามากที่สุด สำหรับ assets นั้นๆ ทำให้เวปโหลดเร็วขึ้น และลดภาระการ Request จาก Web Server เราได้ด้วย</p> <p>อ่านเพิ่มเติม:</p> <p><a href="http://jojoee.com/why-use-a-cdn/">http://jojoee.com/why-use-a-cdn/</a> <a href="https://developers.google.com/speed/libraries/">https://developers.google.com/speed/libraries/</a> <a href="https://en.wikipedia.org/wiki/Content_delivery_network">https://en.wikipedia.org/wiki/Content_delivery_network</a></p> </li> <li> <p>HTTP requests and DNS lookups</p> </li> <li> <p>DNS prefetching มาพูดถึง DNS กันก่อน เอาง่ายๆ ถ้าเรามี HTTP Request ไปยัง domain.com DNS ต้องทำการ Resolve URL to IP Address แปลง domain ไปเป็น IP Address นั่นเอง</p> <p>สมมุติว่าเรามีการ เรียกไฟล์ CSS ไปยังสัก domain.com มันต้องเสียเวลา resolve ใช่ไหมครับ และมันจะเกิดปัญหา Render blocking resource ด้วย</p> <p>ดังนั้น เราจะบอกให้ Browser ไป Resolve URL ล่วงหน้าเลย เมื่อถึงเวลาที่ต้องใช้ CSS เหล่านั้น ในตอน Rendering process จะได้นำไปใช้ได้เลย ไม่ต้องเสียเวลา Resolve URL</p> <p>แต่มันก็มีคำถามมาอยู่ดีว่า Resolve ก่อน หลัง มันก็ไม่ต่างกันอยู่ดีไม่ใช่หรอ คำตอบ คือ ไม่ครับ DNS Prefetching ทำงานแบบ Asynchronous ซึ่งนั่นมันจะไม่ทำให้เกิด Render blocking resource</p> <div class="highlighter-rouge"><pre class="highlight"><code>&lt;link rel="dns-prefetch" href="//example.com"&gt;
</code></pre></div> <p><a href="http://www.siamhtml.com/speed-up-website-with-dns-prefetch/">http://www.siamhtml.com/speed-up-website-with-dns-prefetch/</a> <a href="https://css-tricks.com/prefetching-preloading-prebrowsing/">https://css-tricks.com/prefetching-preloading-prebrowsing/</a> <a href="https://www.chromium.org/developers/design-documents/dns-prefetching">https://www.chromium.org/developers/design-documents/dns-prefetching</a> <a href="http://www.htmlgoodies.com/beyond/webmaster/how-your-browser-speeds-up-cross-domain-loading-using-dns-prefetching.html">http://www.htmlgoodies.com/beyond/webmaster/how-your-browser-speeds-up-cross-domain-loading-using-dns-prefetching.html</a></p> </li> </ol> <h3 id="image--font">Image / Font</h3> <ol> <li> <p>Lossless optimisation</p> </li> <li> <p>Correct image dimension</p> </li> <li> <p>Remove unused assets / Audit and Remove</p> </li> <li> <p>Using the right file image</p> </li> </ol> <p>และนี่เป็นเพียงตัวอย่างคร่าวๆ ที่เหมือนเป็นเชคลิสต์ ทุกครั้งในการเริ่มต้นพัฒนา Frontend ในบทความหน้าผมจะเริ่มเจาะไปทีละตัวครับ</p> <br> <a href="https://twitter.com/intent/tweet?text=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=https://iamgoangle.github.io/2016/07/22/frontend-performance-notes/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="https://iamgoangle.github.io/2016/07/05/getting-started-with-expressjs/" class="pagination_pager" title="เริ่มต้นสร้าง Web Application project ด้วย Express.JS ">previous</a> <a href="#" class="pagination_pager disabled">next</a> </nav> </div> </div> <!-- JS --> <script src="https://iamgoangle.github.io/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://taylantatli.me/Halve/images/halve-home-image.png) center center no-repeat;"> <a href="http://taylantatli.me/Halve" class="inactive" target="_blank" rel="nofollow external"> <span> Halve Jekyll Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://cloud.githubusercontent.com/assets/754514/14509720/61c61058-01d6-11e6-93ab-0918515ecd56.png) center center no-repeat;"> <a href="http://taylantatli.me/Moon" target="_blank" rel="nofollow external"> <span> Moon Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Ramme/master/assets/img/screenshot-post.png) center center no-repeat;"> <a href="http://taylantatli.me/Ramme" target="_blank" rel="nofollow external"> <span> Ramme Jekyll Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Daisy-Pelican-Theme/master/Preview-1.png) center center no-repeat;"> <a href="http://taylantatli.me/Daisy-Pelican-Theme/" target="_blank" rel="nofollow external"> <span> Daisy Pelican Theme </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/Block-Icon-Theme/master/Preview.png) center center no-repeat;"> <a href="https://github.com/TaylanTatli/Block-Icon-Theme" class="inactive" target="_blank" rel="nofollow external"> <span> Block Icon Theme <br><em>in progress</em> </span> </a> </li> <li style="background:url(https://raw.githubusercontent.com/TaylanTatli/StartPage/master/preview.png) center center no-repeat;"> <a href="http://taylantatli.me/StartPage/" class="inactive" target="_blank" rel="nofollow external"> <span> Start Page <br><em>in progress</em> </span> </a> </li> </ul> </div> </body> </html>
